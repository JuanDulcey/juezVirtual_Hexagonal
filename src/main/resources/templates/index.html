<!DOCTYPE html>
<html lang="es"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head th:replace="~{layout/base-layout :: head}"></head>

<body>
<div th:replace="~{layout/base-layout :: nav}"></div>

<!-- Hero principal -->
<section class="hero-section text-white py-5 rounded-4"
         style="background: linear-gradient(135deg, #007bff, #6610f2); box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
  <div class="container text-center py-4">
    <h1 class="display-3 fw-bold mb-3">Juez Virtual de Programación</h1>
    <p class="lead mb-4">Compite, aprende y mejora tus habilidades como un verdadero programador</p>
    <div class="d-flex justify-content-center gap-3 flex-wrap">

      <a th:href="@{/problems}" class="btn btn-outline-light btn-lg px-4 py-2 shadow-sm">
        <i class="fas fa-code me-2"></i> Ver Problemas
      </a>

      <!-- Si el usuario NO ha iniciado sesión -->
      <div sec:authorize="!isAuthenticated()">
        <a th:href="@{/login}" class="btn btn-light btn-lg px-4 py-2 fw-bold text-primary shadow-sm">
          <i class="fas fa-sign-in-alt me-2"></i> Iniciar Sesión
        </a>
        <a th:href="@{/auth/register}" class="btn btn-outline-light btn-lg px-4 py-2 shadow-sm">
          <i class="fas fa-user-plus me-2"></i> Registrarse
        </a>
      </div>

      <!-- Si el usuario ha iniciado sesión -->
      <div sec:authorize="isAuthenticated()" class="d-flex flex-column align-items-center gap-2">
        <p class="fw-bold text-white mb-1">Bienvenido, <span th:text="${#authentication.name}">Usuario</span></p>
        <a th:href="@{/auth/logout}" class="btn btn-outline-light btn-lg px-4 py-2 shadow-sm">
          <i class="fas fa-sign-out-alt me-2"></i> Cerrar Sesión
        </a>
      </div>
    </div>
  </div>

  <button class="btn btn-warning position-absolute end-0 bottom-0 m-4 px-3 py-2 rounded-pill shadow-lg"
          data-bs-toggle="modal" data-bs-target="#chatModal">
    <i class="fas fa-comments me-1"></i> ChatBot
  </button>
</section>

<!-- Sección de características -->
<section class="py-5 bg-light">
  <div class="container">
    <h2 class="text-center mb-5 fw-bold">¿Por qué usar nuestro juez virtual?</h2>

    <div class="row g-4">
      <div class="col-md-4">
        <div class="card border-0 shadow h-100 hover-shadow transition">
          <div class="card-body text-center">
            <div class="icon-circle bg-primary text-white mb-3 mx-auto" style="width:60px; height:60px; border-radius:50%; display:flex; align-items:center; justify-content:center;">
              <i class="fas fa-bolt fa-lg"></i>
            </div>
            <h3 class="h5 mb-2 fw-bold">Feedback Inmediato</h3>
            <p>Recibe resultados al instante y aprende con cada intento.</p>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card border-0 shadow h-100">
          <div class="card-body text-center">
            <div class="icon-circle bg-success text-white mb-3 mx-auto" style="width:60px; height:60px; border-radius:50%; display:flex; align-items:center; justify-content:center;">
              <i class="fas fa-trophy fa-lg"></i>
            </div>
            <h3 class="h5 mb-2 fw-bold">Competiciones</h3>
            <p>Participa en torneos en tiempo real con programadores de todo el país.</p>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card border-0 shadow h-100">
          <div class="card-body text-center">
            <div class="icon-circle bg-warning text-white mb-3 mx-auto" style="width:60px; height:60px; border-radius:50%; display:flex; align-items:center; justify-content:center;">
              <i class="fas fa-chart-line fa-lg"></i>
            </div>
            <h3 class="h5 mb-2 fw-bold">Progreso Personal</h3>
            <p>Haz seguimiento de tus avances, sube de nivel y desbloquea logros.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Modal del ChatBot -->
<div class="modal fade" id="chatModal" tabindex="-1" aria-labelledby="chatModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="chatModalLabel"><i class="fas fa-robot me-2"></i>Chat con el Juez Virtual</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div class="chat-box" id="chatBox" style="height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px;">
          <!-- Mensajes -->
        </div>
        <div class="mt-3 d-flex">
          <input type="text" id="chatInput" class="form-control me-2" placeholder="Escribe tu mensaje...">
          <button class="btn btn-primary" onclick="sendMessage()">Enviar</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div th:replace="~{layout/base-layout :: footer}"></div>

<script>
  async function sendMessage() {
    let message = document.getElementById('chatInput').value.trim();
    if (!message) return;

    let chatBox = document.getElementById('chatBox');
    chatBox.innerHTML += `<div class="text-end text-primary mb-1"><strong>Tú:</strong> ${message}</div>`;

    try {
      let response = await fetch('/api/ask/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message })
      });
      let data = await response.text();
      chatBox.innerHTML += `<div class="text-start text-dark"><strong>Juez Virtual:</strong> ${data}</div>`;
    } catch (error) {
      chatBox.innerHTML += `<div class="text-danger">Error al conectar con el chatbot.</div>`;
    }

    document.getElementById('chatInput').value = '';
    chatBox.scrollTop = chatBox.scrollHeight;
  }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
